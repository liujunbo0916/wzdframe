<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/css/duyun/pc/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/css/duyun/pc/login.css" type="text/css">
    <style type="text/css">
       .error-border{
          border-bottom:1px solid #fc6c38;
       }
    </style>
    
</head>
<body>
<%@ include file="common/ercode.jsp"%>
<div class="row nav-container">
    <div class="col-md-1"></div>
    <div class="col-md-1"></div>
    <div class="col-md-2 nav-logo" onclick="window.location.href='/'">
      <img alt="" src="/img/duyun/pc/LOGO.png">
    </div>
    <div class="col-md-2 "></div>
    <div class="col-md-6"></div>
</div>
<img src="/img/duyun/pc/login/beijing.jpg" class="login-img" alt="">
<div class=" login-content">
    <div class="row login-row">
        <div class="auth-code">
            验证码登陆
        </div>
         <div class="row login-item first" id="errorTip" style="height: 24px;border-bottom:0px solid #FFF;display: none;">
               <p style="font-size: 14px;margin: auto;margin-top: 10px;color:#fc6c38;">验证码输入错误</p>
         </div>
        <div class="row login-item first">
            <div class="col-md-3 col col-item-one">
                <select class="phone-select">
                    <option value="0086">0086</option>
                </select>
            </div>
            <div class="col-md-9 col col-item-two">
                <input type="number" class="blur_change" data-code ="1" name="username" id="username" placeholder="请输入常用手机号"/>
            </div>
        </div>
        <div class="row login-item">
            <div class="col-md-9 col col-item-two">
                <input type="text" id="pcCheckCode" data-code ="2" class="blur_change"  placeholder="" value=""/>
            </div>
            <div class="col-md-3 col col-item-one auth-img">
                <img src="/logic/ercode" style="cursor: pointer;" id="ercodeShow" onclick="chengeErCode(this);" class="down-arrow" alt="">
            </div>
        </div>
        <div class="row login-item last">
            <div class="col-md-9 col col-item-two">
                <input type="text" name="smsCode" data-code ="3" class="blur_change" id="smsCode" placeholder="请输入验证码" value=""/>
            </div>
            <div class="col-md-3 col col-item-one">
                <div role="button"  onclick="requestSmsCode();" style="cursor: pointer;" id="requestSmsCode"  class="btn get-token">获取验证码</div>
            </div>
        </div>
        <div class="login-button">
            <button type="button" id="do_login" style="cursor: pointer;" onclick="doLogin();" class="btn btn-warning login-btn">登录</button>
        </div>
    </div>
</div>
<%@ include file="common/footer.jsp"%>
</body>
<script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/duyun/pc/popper.min.js" type="text/javascript"></script>
<script src="/js/duyun/pc/bootstrap.min.js" type="text/javascript"></script>
<script src="/js/Ajax.js"></script>
<script type="text/javascript" src="/js/InheritString.js"></script>
<script src="/js/BASE64.js"></script>
<script type="text/javascript">
var paramObj = "${param.paramStr}";
var submitFlag = false;

var checkCodeFlag = false; //pc验证码 是否正确

//校验验证码是否正确
var pcCheckCode = function(){
	var checkCode = $("#pcCheckCode").val();
	if(checkCode.isEmpty()){
		errorTipShow($("#pcCheckCode")[0],2);
		return;
	}
	Ajax.request("/logic/checkCode",{"data":{"checkCode":checkCode},"success":function(data){
		if(data.code == 200){
			checkCodeFlag = true;
		}
	}});
}

$(function(){
	$(".blur_change").focus(function(){
		if($("#errorTip").attr("data-code") == $(this).attr("data-code")){
			$("#errorTip").hide();
		}
		$(this).parent().parent().removeClass("error-border");
	});
	$("#pcCheckCode").blur(function(){
		pcCheckCode();
	});
});





function errorTipShow(thisObj,type){
	$("#errorTip").attr("data-code",$(thisObj).attr("data-code"));
	switch (type) {
	case 1:
		$("#errorTip").show();
		$("#errorTip").children(0).text("手机号格式不正确");
		$(thisObj).parent().parent().addClass("error-border");
		break;
	case 2:
		$("#ercodeShow")[0].src = "/logic/ercode?date="+new Date();
		$("#errorTip").show();
		$("#errorTip").children(0).text("验证码不正确");
		$(thisObj).parent().parent().addClass("error-border");
		break;
	case 3:
		$("#errorTip").show();
		$("#errorTip").children(0).text("手机验证码不正确");
		$(thisObj).parent().parent().addClass("error-border");
		break;	
	default:
		break;
	}
}
var doLogin = function(){
	if(submitFlag){
		return;
	}
	var username = $("#username").val();
	var smsCode = $("#smsCode").val();
	if(username.isEmpty()){
	   errorTipShow($("#username")[0],1);
	   return;
	}
	if(smsCode.isEmpty() || smsCode.length != 6){
		errorTipShow($("#smsCode")[0],3);
		return;
	}
	submitFlag = true;
	Ajax.request("/doLoginByCode",{"data":{"username":username,"smsCode":smsCode},"success":function(data){
		submitFlag = false;
		if(data.code == 200){
			if(!paramObj){
			   window.location.href="/";
			}else{
				//如果是从需要登陆的页面跳转过来的
				var _paramObj = Base64.decode(paramObj);
				_paramObj = JSON.parse(_paramObj);
				if(_paramObj.pageType == "productDetail"){
					window.location.href="/product/detail?paramStr="+paramObj;
				}else if(_paramObj.pageType =='productConfirm'){
					window.location.href="/product/order/confirm?paramStr="+paramObj;
				}
			}
		}else{
			alert(data.msg);
		}
	}});
}

$(document).keyup(function(event) {
	if (event.keyCode == 13) {
		$("#do_login").trigger("click");
	}
});
var isSendCode = true;
var timeCount = 60;
var requestSmsCode = function(){
	   if(!isSendCode){
		   return;
	   }
	   var phone = $("#username").val();
	   if(!phone.isPhone()){
		   errorTipShow($("#username")[0],1);
		   return;
	   }
	   if(!checkCodeFlag){
		    errorTipShow($("#pcCheckCode")[0],2);
			return;
	   }
	   isSendCode = false;
	   $("#requestSmsCode").text(timeCount+"重新发送");
	   var a=setInterval(function(){
		   timeCount --;
		   $("#requestSmsCode").text(timeCount+"重新发送");
		   if(timeCount==0){
			   timeCount = 60;
			   isSendCode = true;
			   $("#requestSmsCode").text("发送验证码");
			   clearInterval(a);
		   }
	   },1000);
	   Ajax.request("/sendCode",{"data":{"phone":phone,"codetype":0},"success":function(data){
		   if(data.code == 200){
		   }else{
			   alert(data.msg);
		   }
	   }});
}
function chengeErCode(thisObj){
	 thisObj.src = "/logic/ercode?date="+new Date();
}
</script>
</html>